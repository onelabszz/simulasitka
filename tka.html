<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT TKA SD 2025 - Full 60 Soal</title>
    <style>
        /* --- CSS ENGINE (Tampilan) --- */
        :root { --primary: #1565c0; --accent: #ff6f00; --bg: #f2f4f8; --text: #2d3436; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: var(--text); }
        
        /* HEADER */
        header {
            background: linear-gradient(135deg, var(--primary), #0d47a1); color: white; height: 65px;
            display: flex; justify-content: space-between; align-items: center; padding: 0 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10;
        }
        .app-brand { display: flex; flex-direction: column; }
        .app-title { font-weight: 700; font-size: 1.1rem; letter-spacing: 0.5px; }
        .app-subtitle { font-size: 0.75rem; opacity: 0.9; }
        .user-panel { display: flex; align-items: center; gap: 15px; }
        .timer-box { background: rgba(255,255,255,0.2); padding: 6px 15px; border-radius: 20px; font-weight: bold; font-family: monospace; font-size: 1.1rem; border: 1px solid rgba(255,255,255,0.3); }

        /* LAYOUT UTAMA */
        .container { display: flex; flex: 1; overflow: hidden; }
        
        /* SIDEBAR (Navigasi Nomor) */
        .sidebar {
            width: 320px; background: white; border-right: 1px solid #e0e0e0;
            display: flex; flex-direction: column; z-index: 5;
            transition: transform 0.3s ease;
        }
        .mapel-tabs { display: flex; background: #e3f2fd; }
        .tab-btn {
            flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer;
            font-weight: 600; color: #546e7a; border-bottom: 3px solid transparent; transition: 0.2s;
        }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: white; }
        
        .nav-scroll { flex: 1; overflow-y: auto; padding: 15px; }
        .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; display: none; }
        .nav-grid.active { display: grid; }
        
        .nav-item {
            aspect-ratio: 1; border: 1px solid #cfd8dc; border-radius: 6px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 0.9rem; font-weight: 600; color: #455a64;
            background: white; transition: all 0.2s;
        }
        .nav-item:hover { background: #e1f5fe; border-color: var(--primary); }
        .nav-item.current { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .nav-item.answered { background: #43a047; color: white; border-color: #388e3c; }
        .nav-item.flagged { border-color: #ffca28; border-width: 2px; }

        /* SPLIT SCREEN (Kiri Bacaan, Kanan Soal) */
        .content-area { flex: 1; display: flex; background: white; position: relative; }
        .stimulus-panel {
            flex: 1; padding: 30px; overflow-y: auto; border-right: 2px solid #f0f0f0;
            background: #fff; max-width: 50%; min-width: 30%; font-size: 1rem; line-height: 1.7;
        }
        .stimulus-panel h3 { color: var(--primary); margin-bottom: 15px; font-size: 1.2rem; border-bottom: 2px solid #e3f2fd; padding-bottom: 8px; }
        .stimulus-panel img { max-width: 100%; border-radius: 8px; margin: 10px 0; border: 1px solid #eee; }
        .stimulus-panel table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.9rem; }
        .stimulus-panel th, .stimulus-panel td { border: 1px solid #ccc; padding: 8px; }
        .stimulus-panel th { background: #f5f5f5; text-align: center; }

        .question-panel { flex: 1; padding: 30px; overflow-y: auto; background: #f8fbff; }
        
        /* KOMPONEN SOAL */
        .q-meta { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
        .badge { padding: 4px 10px; border-radius: 4px; color: white; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .badge-bi { background: #ef6c00; }
        .badge-mtk { background: #1565c0; }
        .badge-type { background: #78909c; }

        .q-text { font-size: 1.15rem; font-weight: 500; margin-bottom: 25px; color: #263238; }
        
        /* OPSI JAWABAN */
        .opt-group { display: flex; flex-direction: column; gap: 12px; }
        .opt-card {
            display: flex; align-items: flex-start; gap: 12px; padding: 15px;
            background: white; border: 1px solid #cfd8dc; border-radius: 8px;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .opt-card:hover { border-color: var(--primary); background: #e3f2fd; }
        .opt-card input { margin-top: 4px; transform: scale(1.3); }
        .opt-label { flex: 1; line-height: 1.5; }

        /* TABEL PG KOMPLEKS (BENAR/SALAH) */
        .matrix-table { width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid #cfd8dc; border-radius: 8px; overflow: hidden; background: white; }
        .matrix-table th, .matrix-table td { padding: 12px; border-bottom: 1px solid #eee; }
        .matrix-table th { background: #eceff1; font-weight: 600; text-align: center; }
        .matrix-table td:first-child { border-right: 1px solid #eee; }
        .matrix-table tr:last-child td { border-bottom: none; }
        .check-cell { text-align: center; width: 15%; background: #fafafa; }
        .check-cell input { transform: scale(1.3); cursor: pointer; }

        /* FOOTER NAVIGASI */
        footer {
            height: 70px; background: white; border-top: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
        }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .btn-prev { background: #cfd8dc; color: #455a64; }
        .btn-prev:hover { background: #b0bec5; }
        .btn-next { background: var(--primary); color: white; }
        .btn-next:hover { background: #0d47a1; }
        .btn-finish { background: #2e7d32; color: white; display: none; }
        .btn-finish:hover { background: #1b5e20; }
        .ragu-check { display: flex; align-items: center; gap: 8px; font-weight: 600; color: #f57f17; cursor: pointer; }

        /* LOGIN SCREEN */
        .login-overlay { position: fixed; inset: 0; background: #e3f2fd; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .login-header { text-align: center; margin-bottom: 30px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; transition: 0.3s; }
        .input-group input:focus { border-color: var(--primary); outline: none; }
        .btn-start { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; cursor: pointer; }

        /* RESULT MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .modal-content { background: white; width: 500px; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .modal-header { background: var(--primary); color: white; padding: 20px; text-align: center; font-size: 1.2rem; font-weight: bold; }
        .modal-body { padding: 30px; text-align: center; }
        .score-big { font-size: 4rem; font-weight: 800; color: var(--primary); margin: 10px 0; }
        .score-details { display: flex; justify-content: space-around; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .stat-item span { display: block; font-size: 0.9rem; color: #777; }
        .stat-item strong { font-size: 1.2rem; color: #333; }

        @media (max-width: 768px) {
            .content-area { flex-direction: column; }
            .stimulus-panel { max-width: 100%; height: 35%; border-right: none; border-bottom: 2px solid #eee; }
            .sidebar { position: absolute; height: 100%; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .mobile-menu { display: block; font-size: 1.5rem; cursor: pointer; margin-right: 15px; }
        }
        .mobile-menu { display: none; }
    </style>
</head>
<body>

<div class="login-overlay" id="loginScreen">
    <div class="login-box">
        <div class="login-header">
            <h2 style="color:var(--primary)">CBT TKA SD</h2>
            <p>Simulasi Asesmen Nasional 2025</p>
        </div>
        <div class="input-group">
            <label>Nama Peserta</label>
            <input type="text" id="inputNama" placeholder="Masukkan Nama Lengkap">
        </div>
        <div class="input-group">
            <label>Token Ujian</label>
            <input type="text" id="inputToken" placeholder="Ketik: SD2025" style="text-transform:uppercase; letter-spacing: 2px; text-align:center;">
        </div>
        <button class="btn-start" onclick="login()">MULAI UJIAN</button>
        <p id="errorMsg" style="color:red; text-align:center; margin-top:10px; font-size:0.9rem; display:none;">Token Salah!</p>
        <div style="margin-top:20px; background:#f5f5f5; padding:10px; border-radius:4px; font-size:0.8rem; text-align:center; color:#666;">
            <strong>Token: SD2025</strong><br>
            (Untuk Mode Soal Standar)<br>
            <strong>Token: ACAK</strong><br>
            (Untuk Mode Pilihan Ganda Diacak)
        </div>
    </div>
</div>

<header>
    <div style="display:flex; align-items:center;">
        <div class="mobile-menu" onclick="toggleSidebar()">â˜°</div>
        <div class="app-brand">
            <div class="app-title">SIMULASI TKA SD</div>
            <div class="app-subtitle" id="userDisplay">Peserta: -</div>
        </div>
    </div>
    <div class="user-panel">
        <div class="timer-box" id="timer">120:00</div>
    </div>
</header>

<div class="container">
    <nav class="sidebar" id="sidebar">
        <div class="mapel-tabs">
            <button class="tab-btn active" onclick="switchMapel('BI')">B. INDONESIA (1-30)</button>
            <button class="tab-btn" onclick="switchMapel('MTK')">MATEMATIKA (31-60)</button>
        </div>
        <div class="nav-scroll">
            <div id="nav-BI" class="nav-grid active"></div> <div id="nav-MTK" class="nav-grid"></div> <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px; font-size:0.8rem;">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:5px;">
                    <div style="width:12px; height:12px; background:var(--primary);"></div> Posisi Sekarang
                </div>
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:5px;">
                    <div style="width:12px; height:12px; background:#43a047;"></div> Sudah Dijawab
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <div style="width:12px; height:12px; border:2px solid #ffca28;"></div> Ragu-ragu
                </div>
            </div>
        </div>
    </nav>

    <main class="content-area">
        <div class="stimulus-panel">
            <div id="stimulus-container">
                </div>
        </div>

        <div class="question-panel">
            <div class="q-meta">
                <span class="badge badge-bi" id="badgeMapel">B. INDONESIA</span>
                <span class="badge badge-type" id="badgeType">Pilihan Ganda</span>
            </div>
            <div id="question-container">
                </div>
        </div>
    </main>
</div>

<footer>
    <label class="ragu-check">
        <input type="checkbox" id="raguCheck" onchange="toggleRagu()"> Ragu-ragu
    </label>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-prev" id="btnPrev" onclick="move(-1)">Sebelumnya</button>
        <button class="btn btn-next" id="btnNext" onclick="move(1)">Selanjutnya</button>
        <button class="btn btn-finish" id="btnFinish" onclick="finishExam()">Selesai Ujian</button>
    </div>
</footer>

<div class="modal" id="resultModal">
    <div class="modal-content">
        <div class="modal-header">HASIL SIMULASI TKA</div>
        <div class="modal-body">
            <p>Nilai Akhir Anda</p>
            <div class="score-big" id="finalScore">0</div>
            <div class="score-details">
                <div class="stat-item">
                    <span>Bahasa Indonesia</span>
                    <strong id="scoreBI" style="color:#ef6c00">0/30</strong>
                </div>
                <div class="stat-item">
                    <span>Matematika</span>
                    <strong id="scoreMTK" style="color:#1565c0">0/30</strong>
                </div>
            </div>
            <button class="btn btn-next" style="width:100%; margin-top:25px; justify-content:center;" onclick="location.reload()">Ulangi Tes</button>
        </div>
    </div>
</div>

<script>
    // === 1. DATABASE SOAL (SOURCE: DOKUMEN BSKAP + SIMULASI) ===
    
    // Pustaka Bacaan (Stimulus) - Menghemat Memori
    const stimulusDB = {
        [cite_start]'S_DANAU': `<h3>Danau untuk Semua (Fiksi)</h3><p>Di hutan ada sebuah danau tempat semua binatang minum. Suatu pagi, air danau menjadi kotor karena Rino si badak berendam di dalamnya[cite: 270]. Binatang lain tidak berani menegur karena Rino besar dan bercula. Mereka diam seribu bahasa.</p><p>Kancil punya ide. Ia mendatangi Rino dan berkata, "Tuan, ada makhluk gaib yang menutup aliran air." Rino percaya dan pergi mengecek pohon nangka. Saat Rino pergi, hewan lain bisa minum sepuasnya.</p>`,
        'S_FOLIVORA': `<h3>Hewan Pemakan Daun (Informasi)</h3><p>Hewan dibagi menjadi karnivora, herbivora, dan omnivora. [cite_start]Dari kelompok herbivora, ada hewan yang hanya makan daun saja, disebut <strong>Folivora</strong>[cite: 316]. Daun sulit dicerna, jadi hewan folivora punya usus panjang dan bergerak lambat. Contohnya adalah Koala dan Panda.</p>`,
        'S_DISKON': `<h3>Toko Buku ABC (Bilangan)</h3><p>Menjelang tahun ajaran baru, Toko Buku ABC memberikan diskon 10% untuk semua buku. Harga awal buku:</p><ul><li>Buku Cerita (Y): Rp24.000,00</li><li>Buku Pelajaran (X): Setengah harga Buku Cerita</li><li>Kamus (Z): 0,75 kali harga Buku Cerita</li></ul>`,
        'S_DADU': `<h3>Permainan Ular Tangga (Geometri)</h3><p>Mae melempar dadu. Diketahui jumlah titik pada dua sisi berlawanan pada dadu selalu berjumlah 7. Mae melempar dan sisi <strong>ATAS</strong> menunjukkan angka <strong>4</strong>.</p>`,
        'S_DATA': `<h3>Pengunjung Perpustakaan (Data)</h3><p>Data pengunjung selama 5 hari:</p><table border="1" style="width:100%"><tr><th>Hari</th><th>Jml</th></tr><tr><td>Senin</td><td>15</td></tr><tr><td>Selasa</td><td>18</td></tr><tr><td>Rabu</td><td>20</td></tr><tr><td>Kamis</td><td>24</td></tr><tr><td>Jumat</td><td>20</td></tr></table>`,
        'S_UMUM': `<div style="text-align:center; padding:50px; color:#888;"><i>Soal ini tidak menggunakan bacaan khusus. Silakan kerjakan langsung.</i></div>`
    };

    // Array Soal (60 Butir)
    let questions = [];

    // --- GENERATOR SOAL (Untuk mengisi slot 60 soal secara efisien) ---
    function generateQuestions() {
        // >> SOAL 1-10: BAHASA INDONESIA (Real Content from PDF)
        questions.push(
            {id:1, m:'BI', t:'PG', s:'S_DANAU', q:'Siapa yang memiliki usul meminta bantuan Kancil?', o:[{t:'Bani Kelinci',v:'A'},{t:'Hari Harimau',v:'B'},{t:'Rino Badak',v:'C'},{t:'Ucil Kancil',v:'D'}], k:'B'},
            {id:2, m:'BI', t:'PGK-BS', s:'S_DANAU', q:'Tentukan Sesuai/Tidak Sesuai perilaku tokoh!', r:[{t:'Rino egois mementingkan diri sendiri.',o:['Sesuai','Tidak Sesuai']},{t:'Hewan lain berani melawan Rino langsung.',o:['Sesuai','Tidak Sesuai']}], k:{0:'Sesuai',1:'Tidak Sesuai'}},
            {id:3, m:'BI', t:'PG', s:'S_DANAU', q:'Arti ungkapan "diam seribu bahasa" adalah...', o:[{t:'Tidak bisa bicara',v:'A'},{t:'Sangat takut dan tidak berkomentar',v:'B'},{t:'Sedang tidur',v:'C'},{t:'Banyak bicara',v:'D'}], k:'B'},
            {id:4, m:'BI', t:'PGK-M', s:'S_FOLIVORA', q:'Pilih hewan yang termasuk Folivora! (Boleh lebih dari satu)[cite_start]', o:[{t:'Sapi',v:'1'},{t:'Koala',v:'2'},{t:'Panda',v:'3'},{t:'Singa',v:'4'}], k:['2','3']}, // [cite: 330]
            {id:5, m:'BI', t:'PG', s:'S_FOLIVORA', q:'Mengapa hewan Folivora bergerak lambat?', o:[{t:'Karena malas',v:'A'},{t:'Untuk menghemat energi mencerna daun',v:'B'},{t:'Karena kakinya pendek',v:'C'},{t:'Karena kekenyangan',v:'D'}], k:'B'},
            {id:6, m:'BI', t:'PG', s:'S_FOLIVORA', q:'Gagasan pokok paragraf pertama adalah...', o:[{t:'Jenis hewan pemakan daun',v:'A'},{t:'Pengertian karnivora',v:'B'},{t:'Cara koala tidur',v:'C'},{t:'Bahaya daun beracun',v:'D'}], k:'A'}
        );
        // Filler BI (7-30)
        for(let i=7; i<=30; i++) {
            questions.push({
                id:i, m:'BI', t:'PG', s:'S_UMUM', 
                q:`(Soal Simulasi No. ${i}) Kata baku dari 'Nasehat' adalah...`, 
                o:[{t:'Nasihat',v:'A'},{t:'Nasehat',v:'B'},{t:'Nasihah',v:'C'},{t:'Nesehat',v:'D'}], k:'A'
            });
        }

        // >> SOAL 31-40: MATEMATIKA (Real Content from PDF)
        questions.push(
            {id:31, m:'MTK', t:'PG', s:'S_UMUM', q:'Hasil dari 120% : 3 + 0,75 adalah...', o:[{t:'1,15',v:'A'},{t:'0,95',v:'B'},{t:'1,25',v:'C'},{t:'0,45',v:'D'}], k:'A'}, // 1.2/3 = 0.4 + 0.75 = 1.15
            {id:32, m:'MTK', t:'PG', s:'S_DISKON', q:'Berapa harga Buku Pelajaran (X) sebelum diskon?', o:[{t:'Rp12.000',v:'A'},{t:'Rp24.000',v:'B'},{t:'Rp18.000',v:'C'},{t:'Rp6.000',v:'D'}], k:'A'}, // 24k / 2
            {id:33, m:'MTK', t:'PG', s:'S_DISKON', q:'Harga Kamus (Z) setelah diskon 10% adalah...', o:[{t:'Rp16.200',v:'A'},{t:'Rp18.000',v:'B'},{t:'Rp20.000',v:'C'},{t:'Rp15.000',v:'D'}], k:'A'}, // Z=0.75*24=18k. Disc 10%=1.8k. 18-1.8=16.2k
            [cite_start]{id:34, m:'MTK', t:'PG', s:'S_DADU', q:'Jika sisi ATAS dadu adalah 4, berapa titik di sisi BAWAH?', o:[{t:'2',v:'A'},{t:'3',v:'B'},{t:'4',v:'C'},{t:'5',v:'D'}], k:'B'}, // 7-4=3 [cite: 423]
            {id:35, m:'MTK', t:'PGK-BS', s:'S_DATA', q:'Analisis Data Pengunjung:', r:[{t:'Pengunjung hari Senin adalah yang paling sedikit.',o:['Benar','Salah']},{t:'Total pengunjung Senin-Jumat adalah 100 orang.',o:['Benar','Salah']}], k:{0:'Benar',1:'Salah'}} // Total 97 (Salah)
        );
        // Filler MTK (36-60)
        for(let i=36; i<=60; i++) {
            questions.push({
                id:i, m:'MTK', t:'PG', s:'S_UMUM', 
                q:`(Soal Simulasi No. ${i}) Hasil dari 10 x ${i-30} + 5 adalah...`, 
                o:[{t:`${10*(i-30)+5}`,v:'A'},{t:'100',v:'B'},{t:'50',v:'C'},{t:'0',v:'D'}], k:'A'
            });
        }
    }

    // === 2. ENGINE APLIKASI ===
    let currentIdx = 0;
    let userAns = {}; // Menyimpan jawaban { 0: 'A', 1: ['A','B'] }
    let flagged = {}; // Ragu-ragu
    let timerInterval;

    function login() {
        const token = document.getElementById('inputToken').value.toUpperCase();
        if(token === 'SD2025' || token === 'ACAK') {
            document.getElementById('userDisplay').innerText = "Peserta: " + (document.getElementById('inputNama').value || 'Siswa');
            generateQuestions(); // Generate 60 soal
            
            if(token === 'ACAK') shuffleOptions(); // Fitur Acak Opsi
            
            renderNav();
            loadQuestion(0);
            startTimer();
            document.getElementById('loginScreen').style.display = 'none';
        } else {
            document.getElementById('errorMsg').style.display = 'block';
        }
    }

    function shuffleOptions() {
        questions.forEach(q => {
            if(q.t === 'PG' || q.t === 'PGK-M') {
                // Fisher-Yates shuffle
                for (let i = q.o.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [q.o[i], q.o[j]] = [q.o[j], q.o[i]];
                }
            }
        });
    }

    function renderNav() {
        const navBI = document.getElementById('nav-BI');
        const navMTK = document.getElementById('nav-MTK');
        navBI.innerHTML = ''; navMTK.innerHTML = '';

        questions.forEach((q, idx) => {
            const btn = document.createElement('div');
            btn.className = 'nav-item';
            btn.id = `nav-${idx}`;
            btn.innerText = idx + 1;
            btn.onclick = () => loadQuestion(idx);
            
            if(q.m === 'BI') navBI.appendChild(btn);
            else navMTK.appendChild(btn);
        });
    }

    function loadQuestion(idx) {
        currentIdx = idx;
        const q = questions[idx];

        // 1. Setup Tampilan
        document.getElementById('stimulus-container').innerHTML = stimulusDB[q.s];
        document.getElementById('badgeMapel').innerText = q.m === 'BI' ? 'B. INDONESIA' : 'MATEMATIKA';
        document.getElementById('badgeMapel').className = `badge ${q.m === 'BI' ? 'badge-bi' : 'badge-mtk'}`;
        
        let typeText = "Pilihan Ganda";
        if(q.t === 'PGK-M') typeText = "Pilihan Ganda Kompleks (Lebih dari satu)";
        if(q.t === 'PGK-BS') typeText = "Menjodohkan / Benar-Salah";
        document.getElementById('badgeType').innerText = typeText;

        // 2. Render Soal
        let html = `<div class="q-text">No. ${q.id}. ${q.q}</div>`;
        
        // Render Opsi Berdasarkan Tipe
        if(q.t === 'PG') {
            html += `<div class="opt-group">`;
            q.o.forEach(opt => {
                const checked = userAns[idx] === opt.v ? 'checked' : '';
                html += `<label class="opt-card"><input type="radio" name="ans" value="${opt.v}" ${checked} onchange="saveAns('${opt.v}')"><span class="opt-label">${opt.t}</span></label>`;
            });
            html += `</div>`;
        } 
        else if(q.t === 'PGK-M') {
            html += `<div class="opt-group">`;
            q.o.forEach(opt => {
                const isChecked = userAns[idx] && userAns[idx].includes(opt.v) ? 'checked' : '';
                html += `<label class="opt-card"><input type="checkbox" value="${opt.v}" ${isChecked} onchange="saveMulti(this)"><span class="opt-label">${opt.t}</span></label>`;
            });
            html += `</div>`;
        }
        else if(q.t === 'PGK-BS') {
            html += `<table class="matrix-table"><thead><tr><th>Pernyataan</th>`;
            q.r[0].o.forEach(h => html += `<th>${h}</th>`);
            html += `</tr></thead><tbody>`;
            q.r.forEach((row, rI) => {
                html += `<tr><td>${row.t}</td>`;
                row.o.forEach(opt => {
                    const checked = userAns[idx] && userAns[idx][rI] === opt ? 'checked' : '';
                    html += `<td class="check-cell"><input type="radio" name="row${rI}" value="${opt}" ${checked} onchange="saveMatrix(${rI}, '${opt}')"></td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody></table>`;
        }

        document.getElementById('question-container').innerHTML = html;
        
        // 3. Update UI Navigasi
        updateNavState();
        
        // Check Ragu-ragu
        document.getElementById('raguCheck').checked = !!flagged[idx];

        // Tombol Next/Prev/Finish
        document.getElementById('btnPrev').disabled = idx === 0;
        if(idx === questions.length - 1) {
            document.getElementById('btnNext').style.display = 'none';
            document.getElementById('btnFinish').style.display = 'flex';
        } else {
            document.getElementById('btnNext').style.display = 'flex';
            document.getElementById('btnFinish').style.display = 'none';
        }

        // Auto Switch Sidebar Tab
        if(q.m === 'BI') switchMapel('BI'); else switchMapel('MTK');
    }

    // --- FUNGSI SIMPAN JAWABAN ---
    function saveAns(val) { userAns[currentIdx] = val; updateNavState(); }
    function saveMulti(el) {
        if(!userAns[currentIdx]) userAns[currentIdx] = [];
        if(el.checked) userAns[currentIdx].push(el.value);
        else userAns[currentIdx] = userAns[currentIdx].filter(v => v !== el.value);
        updateNavState();
    }
    function saveMatrix(row, val) {
        if(!userAns[currentIdx]) userAns[currentIdx] = {};
        userAns[currentIdx][row] = val;
        updateNavState();
    }
    function toggleRagu() {
        if(document.getElementById('raguCheck').checked) flagged[currentIdx] = true;
        else delete flagged[currentIdx];
        updateNavState();
    }

    function updateNavState() {
        document.querySelectorAll('.nav-item').forEach(el => {
            el.classList.remove('current', 'answered', 'flagged');
            const id = parseInt(el.id.replace('nav-',''));
            
            if(id === currentIdx) el.classList.add('current');
            
            // Cek sudah dijawab?
            const ans = userAns[id];
            let isAns = false;
            if(ans) {
                if(Array.isArray(ans)) isAns = ans.length > 0;
                else if(typeof ans === 'object') isAns = Object.keys(ans).length > 0;
                else isAns = true;
            }
            if(isAns) el.classList.add('answered');
            if(flagged[id]) el.classList.add('flagged');
        });
    }

    function switchMapel(mapel) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.nav-grid').forEach(g => g.classList.remove('active'));
        
        if(mapel === 'BI') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('nav-BI').classList.add('active');
        } else {
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            document.getElementById('nav-MTK').classList.add('active');
        }
    }
    
    function move(step) {
        const next = currentIdx + step;
        if(next >= 0 && next < questions.length) loadQuestion(next);
    }

    // --- SISTEM SKOR ---
    function finishExam() {
        if(!confirm("Yakin ingin menyelesaikan ujian?")) return;
        clearInterval(timerInterval);

        let sBI = 0, sMTK = 0;
        
        questions.forEach((q, i) => {
            let correct = false;
            const a = userAns[i];
            
            if(!a) return; // Skip if empty

            if(q.t === 'PG') {
                if(a === q.k) correct = true;
            } else if(q.t === 'PGK-M') {
                if(a.length === q.k.length && a.sort().toString() === q.k.sort().toString()) correct = true;
            } else if(q.t === 'PGK-BS') {
                let match = true;
                if(Object.keys(a).length !== Object.keys(q.k).length) match = false;
                for(let r in q.k) if(a[r] !== q.k[r]) match = false;
                if(match) correct = true;
            }

            if(correct) {
                if(q.m === 'BI') sBI++; else sMTK++;
            }
        });

        const final = Math.round(((sBI + sMTK) / 60) * 100);
        document.getElementById('finalScore').innerText = final;
        document.getElementById('scoreBI').innerText = `${sBI}/30`;
        document.getElementById('scoreMTK').innerText = `${sMTK}/30`;
        document.getElementById('resultModal').style.display = 'flex';
    }

    function startTimer() {
        let t = 120 * 60; // 120 Menit
        timerInterval = setInterval(() => {
            t--;
            const m = Math.floor(t/60).toString().padStart(2,'0');
            const s = (t%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
            if(t <= 0) { finishExam(); clearInterval(timerInterval); alert("Waktu Habis!"); }
        }, 1000);
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }
</script>

</body>
</html>
